<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPOTIMIX - Heatmap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <a class="side-icon" href="index.html" title="Dashboard">
            <i class="fa-solid fa-house"></i>
        </a>
        <a class="side-icon home" href="heatmap.html" title="Heatmap">
            <i class="fa-solid fa-border-all"></i>
        </a>
        <a class="side-icon" href="scatter.html" title="Scatter Plot">
            <i class="fa-solid fa-chart-scatter"></i>
        </a>
        <a class="side-icon" href="genrasExplore.html" title="Exploration par genres">
            <i class="fa-solid fa-chart-pie"></i>
        </a>
        <a class="side-icon" href="#" title="Graph √† venir">
            <i class="fa-solid fa-sliders"></i>
        </a>
    </aside>

    <!-- Topbar -->
    <header class="topbar">
        <h1 class="brand">SPOTIMIX</h1>
        <div class="toolbar">
            <label class="select">
                <select id="genre-select">
                    <option>Choisir un genre</option>
                    <!-- Les genres seront charg√©s dynamiquement -->
                </select>
            </label>
            <label class="select">
                <select id="year-min-select">
                    <option value="">Min</option>
                    <!-- Les ann√©es seront charg√©es dynamiquement -->
                </select>
            </label>
            <label class="select">
                <select id="year-max-select">
                    <option value="">Max</option>
                    <!-- Les ann√©es seront charg√©es dynamiquement -->
                </select>
            </label>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard" style="grid-template-columns: 1fr; grid-template-rows: 1fr;">
        <div class="panel" style="grid-column: 1; grid-row: 1;">
            <div class="panel__title">Heatmap - Analyse des caract√©ristiques musicales</div>
            <div class="panel__body">
                <div id="heatmap-container" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </main>

    <!-- Script for Heatmap -->
    <script type="module">
        // Imports ES6
        import { DataLoader } from './js/DataLoader.js';
        import { HeatmapProcessor } from './js/HeatmapProcessor.js';
        import { HeatmapChart } from './js/HeatmapChart.js';

        console.log('üé® Heatmap page loaded');

        // Variables globales pour les filtres actifs
        let allTracks = [];
        let currentGenreFilter = 'Choisir un genre';
        let currentYearMin = null;
        let currentYearMax = null;
        let heatmapChart = null;

        // Fonction principale pour initialiser la heatmap
        async function initHeatmap() {
            try {
                console.log('üîÑ Initialisation de la heatmap...');

                // Utiliser le DataLoader pour charger les donn√©es
                const dataLoader = DataLoader.getInstance();
                allTracks = await dataLoader.loadSpotifyData();

                console.log(`üìä ${allTracks.length} pistes charg√©es`);

                // Cr√©er l'instance de HeatmapChart
                heatmapChart = new HeatmapChart('heatmap-container');

                // Setup des filtres
                setupGenreFilter();
                setupYearFilter();

                // Traiter et afficher les donn√©es initiales
                updateHeatmap();

                console.log('‚úÖ Heatmap initialis√©e avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                showError('Erreur lors du chargement de la heatmap');
            }
        }

        // Fonction pour mettre √† jour la heatmap avec les filtres actuels
        function updateHeatmap() {
            // Utiliser HeatmapProcessor pour traiter les donn√©es
            const heatmapData = HeatmapProcessor.processHeatmapData(
                allTracks,
                currentGenreFilter,
                currentYearMin,
                currentYearMax
            );

            console.log(`üìà ${heatmapData.length} cellules de heatmap cr√©√©es`);

            // Limiter aux top 30 artistes
            const topData = HeatmapProcessor.getTopArtists(heatmapData, 30);

            // Utiliser HeatmapChart pour rendre la visualisation
            heatmapChart.render(topData, allTracks, currentYearMin, currentYearMax);
        }

        // Configuration du filtre de genre
        function setupGenreFilter() {
            const genreSelect = d3.select('#genre-select');

            // Utiliser HeatmapProcessor pour extraire les genres
            const uniqueGenres = HeatmapProcessor.getUniqueGenres(allTracks);

            console.log(`üéµ ${uniqueGenres.length} genres trouv√©s`);

            // Ajouter chaque genre au select
            uniqueGenres.forEach(genre => {
                genreSelect.append('option')
                    .text(genre.charAt(0).toUpperCase() + genre.slice(1))
                    .attr('value', genre);
            });

            // G√©rer le changement de filtre
            genreSelect.on('change', function () {
                currentGenreFilter = this.value;
                console.log('Genre s√©lectionn√©:', currentGenreFilter);
                updateHeatmap();
            });
        }

        // Configuration du filtre d'ann√©es
        function setupYearFilter() {
            const yearMinSelect = d3.select('#year-min-select');
            const yearMaxSelect = d3.select('#year-max-select');

            // Utiliser HeatmapProcessor pour extraire les ann√©es
            const uniqueYears = HeatmapProcessor.getUniqueYears(allTracks);

            console.log(`üìÖ ${uniqueYears.length} ann√©es trouv√©es: ${uniqueYears[0]} - ${uniqueYears[uniqueYears.length - 1]}`);

            // Ajouter chaque ann√©e aux deux selects
            uniqueYears.forEach(year => {
                yearMinSelect.append('option')
                    .text(year)
                    .attr('value', year);

                yearMaxSelect.append('option')
                    .text(year)
                    .attr('value', year);
            });

            // G√©rer le changement de filtre min
            yearMinSelect.on('change', function () {
                const selectedMin = this.value ? parseInt(this.value) : null;

                if (selectedMin === null) {
                    currentYearMin = null;
                    updateYearMaxOptions(uniqueYears, null);
                    updateHeatmap();
                    return;
                }

                if (currentYearMax !== null && selectedMin > currentYearMax) {
                    yearMaxSelect.property('value', '');
                    currentYearMax = null;
                }

                currentYearMin = selectedMin;
                updateYearMaxOptions(uniqueYears, currentYearMin);
                updateHeatmap();
            });

            // G√©rer le changement de filtre max
            yearMaxSelect.on('change', function () {
                const selectedMax = this.value ? parseInt(this.value) : null;

                if (selectedMax === null) {
                    currentYearMax = null;
                    updateYearMinOptions(uniqueYears, null);
                    updateHeatmap();
                    return;
                }

                if (currentYearMin !== null && selectedMax < currentYearMin) {
                    yearMinSelect.property('value', '');
                    currentYearMin = null;
                }

                currentYearMax = selectedMax;
                updateYearMinOptions(uniqueYears, currentYearMax);
                updateHeatmap();
            });

            function updateYearMinOptions(years, maxYear) {
                const currentValue = yearMinSelect.property('value');
                yearMinSelect.selectAll('option:not([value=""])').remove();

                years.forEach(year => {
                    const option = yearMinSelect.append('option')
                        .text(year)
                        .attr('value', year);

                    if (maxYear !== null && year > maxYear) {
                        option.attr('disabled', 'disabled').style('color', '#999');
                    }
                });

                if (currentValue && (maxYear === null || parseInt(currentValue) <= maxYear)) {
                    yearMinSelect.property('value', currentValue);
                }
            }

            function updateYearMaxOptions(years, minYear) {
                const currentValue = yearMaxSelect.property('value');
                yearMaxSelect.selectAll('option:not([value=""])').remove();

                years.forEach(year => {
                    const option = yearMaxSelect.append('option')
                        .text(year)
                        .attr('value', year);

                    if (minYear !== null && year < minYear) {
                        option.attr('disabled', 'disabled').style('color', '#999');
                    }
                });

                if (currentValue && (minYear === null || parseInt(currentValue) >= minYear)) {
                    yearMaxSelect.property('value', currentValue);
                }
            }
        }

        // Afficher un message d'erreur
        function showError(message) {
            const container = d3.select('#heatmap-container');
            container.selectAll('*').remove();
            container.append('div')
                .style('color', 'red')
                .style('padding', '20px')
                .style('text-align', 'center')
                .text(`‚ùå ${message}`);
        }

        // Initialiser au chargement de la page
        initHeatmap();
    </script>
</body>

</html>